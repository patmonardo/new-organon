// @organon/model Prisma Schema
// Low-cost Postgres persistence for FactStore/KnowledgeStore projections

generator client {
  provider = "prisma-client-js"
}

// PostgreSQL - supports Json columns needed for FormStore
// Quick start: docker run -d --name organon-db -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=organon -p 5432:5432 postgres:16
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENTITY: Core data entities (projects from @logic Entity)
// ============================================================

model Entity {
  id        String   @id @default(cuid())
  type      String
  name      String?
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties Property[]
  sourceRelations Relation[] @relation("SourceEntity")
  targetRelations Relation[] @relation("TargetEntity")

  @@index([type])
  @@map("entities")
}

// ============================================================
// PROPERTY: Entity attributes (projects from @logic Property)
// ============================================================

model Property {
  id        String   @id @default(cuid())
  name      String
  value     Json
  type      String   @default("string")
  entityId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
  @@index([name])
  @@map("properties")
}

// ============================================================
// RELATION: Entity connections (projects from @logic Relation)
// ============================================================

model Relation {
  id        String   @id @default(cuid())
  type      String
  sourceId  String
  targetId  String
  weight    Float?   @default(1.0)
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source    Entity   @relation("SourceEntity", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Entity   @relation("TargetEntity", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([sourceId])
  @@index([targetId])
  @@map("relations")
}

// ============================================================
// DASHBOARD: Dashboard configurations
// ============================================================

model Dashboard {
  id          String   @id @default(cuid())
  name        String
  title       String?
  description String?
  config      Json     // Full dashboard shape as JSON
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  components  DashboardComponent[]

  @@map("dashboards")
}

model DashboardComponent {
  id          String   @id @default(cuid())
  dashboardId String
  type        String   // 'stat-card', 'concept-cloud', 'explorations-list', etc.
  title       String?
  position    Json     // { x, y, w, h }
  config      Json     // Component-specific configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([type])
  @@map("dashboard_components")
}

// ============================================================
// USER: For exploration tracking (optional)
// ============================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  explorations Exploration[]

  @@map("users")
}

model Exploration {
  id          String   @id @default(cuid())
  title       String
  description String?
  query       Json?    // The exploration query/state
  results     Json?    // Cached results
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("explorations")
}

// ============================================================
// CONCEPT: Knowledge graph concepts
// ============================================================

model Concept {
  id        String   @id @default(cuid())
  name      String
  category  String?
  frequency Int      @default(0)
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([frequency])
  @@map("concepts")
}

// ============================================================
// FACTSTORE: Appearance → Fact → Assertion pipeline
// Essential Being - Ground-Condition-Facticity
// ============================================================

model Appearance {
  id          String   @id @default(cuid())
  groundHint  String?
  rawBlob     Json
  recordedBy  String?
  recordedAt  DateTime @default(now())

  // Relations
  facts       Fact[]

  @@index([groundHint])
  @@map("appearances")
}

model Fact {
  id              String      @id @default(cuid())
  ground          String
  predicate       String
  value           Json
  appearanceId    String?
  createdAt       DateTime    @default(now())

  // Relations
  appearance      Appearance? @relation(fields: [appearanceId], references: [id], onDelete: SetNull)
  assertions      Assertion[]

  @@index([ground])
  @@index([predicate])
  @@index([appearanceId])
  @@map("facts")
}

model Assertion {
  id            String    @id @default(cuid())
  factId        String
  issuer        String
  context       String?
  confidence    Float?
  tags          String[]  @default([])  // Postgres native array
  provenance    Json?
  validFrom     DateTime?
  validTo       DateTime?
  createdAt     DateTime  @default(now())

  // Relations
  fact          Fact      @relation(fields: [factId], references: [id], onDelete: Cascade)

  @@index([factId])
  @@index([issuer])
  @@map("assertions")
}

// ============================================================
// FORMSTORE: Business Forms - User Defined Types for Forms
// Data Model Standard Library
// ============================================================

model Form {
  id          String   @id @default(cuid())
  name        String
  title       String?
  description String?
  type        String   @default("form")
  version     Int      @default(1)
  status      String   @default("draft")  // draft, active, archived
  config      Json?    @default("{}")     // Full FormShape as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  fields      FormField[]
  sections    FormSection[]
  submissions FormSubmission[]

  @@index([type])
  @@index([status])
  @@map("forms")
}

model FormField {
  id           String   @id @default(cuid())
  formId       String
  name         String
  label        String?
  type         String   @default("text")  // text, number, email, select, etc.
  required     Boolean  @default(false)
  placeholder  String?
  defaultValue Json?
  validation   Json?    // Validation rules
  options      Json?    // For select/radio/checkbox
  order        Int      @default(0)
  sectionId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  form         Form        @relation(fields: [formId], references: [id], onDelete: Cascade)
  section      FormSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  @@index([formId])
  @@index([sectionId])
  @@index([order])
  @@map("form_fields")
}

model FormSection {
  id          String   @id @default(cuid())
  formId      String
  name        String
  title       String?
  description String?
  order       Int      @default(0)
  collapsible Boolean  @default(false)
  collapsed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  form        Form       @relation(fields: [formId], references: [id], onDelete: Cascade)
  fields      FormField[]

  @@index([formId])
  @@index([order])
  @@map("form_sections")
}

model FormSubmission {
  id        String   @id @default(cuid())
  formId    String
  data      Json     // The submitted values
  status    String   @default("pending")  // pending, approved, rejected
  submittedBy String?
  submittedAt DateTime @default(now())
  processedAt DateTime?
  notes     String?

  // Relations
  form      Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([status])
  @@index([submittedAt])
  @@map("form_submissions")
}
