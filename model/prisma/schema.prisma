// @organon/model Prisma Schema
// Low-cost Postgres persistence for FactStore/KnowledgeStore projections

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENTITY: Core data entities (projects from @logic Entity)
// ============================================================

model Entity {
  id        String   @id @default(cuid())
  type      String
  name      String?
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties Property[]
  sourceRelations Relation[] @relation("SourceEntity")
  targetRelations Relation[] @relation("TargetEntity")

  @@index([type])
  @@map("entities")
}

// ============================================================
// PROPERTY: Entity attributes (projects from @logic Property)
// ============================================================

model Property {
  id        String   @id @default(cuid())
  name      String
  value     Json
  type      String   @default("string")
  entityId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
  @@index([name])
  @@map("properties")
}

// ============================================================
// RELATION: Entity connections (projects from @logic Relation)
// ============================================================

model Relation {
  id        String   @id @default(cuid())
  type      String
  sourceId  String
  targetId  String
  weight    Float?   @default(1.0)
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source    Entity   @relation("SourceEntity", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Entity   @relation("TargetEntity", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([sourceId])
  @@index([targetId])
  @@map("relations")
}

// ============================================================
// DASHBOARD: Dashboard configurations
// ============================================================

model Dashboard {
  id          String   @id @default(cuid())
  name        String
  title       String?
  description String?
  config      Json     // Full dashboard shape as JSON
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  components  DashboardComponent[]

  @@map("dashboards")
}

model DashboardComponent {
  id          String   @id @default(cuid())
  dashboardId String
  type        String   // 'stat-card', 'concept-cloud', 'explorations-list', etc.
  title       String?
  position    Json     // { x, y, w, h }
  config      Json     // Component-specific configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([type])
  @@map("dashboard_components")
}

// ============================================================
// USER: For exploration tracking (optional)
// ============================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  explorations Exploration[]

  @@map("users")
}

model Exploration {
  id          String   @id @default(cuid())
  title       String
  description String?
  query       Json?    // The exploration query/state
  results     Json?    // Cached results
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("explorations")
}

// ============================================================
// CONCEPT: Knowledge graph concepts
// ============================================================

model Concept {
  id        String   @id @default(cuid())
  name      String
  category  String?
  frequency Int      @default(0)
  data      Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([frequency])
  @@map("concepts")
}
